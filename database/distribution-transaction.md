# Distribution Transaction

- 数据的并发访问、修改
- 不同请求之间的数据隔离
- 一个业务请求修改多个数据，保证都完成或失败
- 发生异常时进行数据回滚

jta：xa规范在java的实现

分布式事务就是为了解决不同数据源间的事务特性

强一致性，弱一致性，最终一致性

强一致性：系统中的数据与操作顺序完全一致，任意时刻，所有节点中的数据都是一样的、

弱一致性：数据更新后，可以容忍后续的访问只能访问到部分或者全部访问不到

最终一致性：不保证任意时刻任意节点上的同一份数据都是相同的，但在一段数据后节点间的数据最终后达到一致的状态

### CAP 原则

又称 CAP 定理，指的是在一个分布式系统中， Consistency（一致性）、 Availability（可用性）、Partition tolerance（分区容错性），三者不可得兼。

1. Consistency(一致性)： 在分布式系统中，一个节点已提交的写操作都可以立即被其他任意节点查询到数据的最新状态。

   一致性的实现：

   1. 写入主数据库后要将数据同步到从数据库。 

   2. 写入主数据库后，在向从数据库同步期间要将从数据库锁定，待同步完成后再释放锁，以免在新数据写入成功 后，向从数据库查询到旧的数据。

   分布式系统一致性的特点： 

   1. 由于存在数据同步的过程，写操作的响应会有一定的延迟。 

   2. 为了保证数据一致性会对资源暂时锁定，待数据同步完成释放锁定资源。 

   3. 如果请求数据同步失败的结点则会返回错误信息，一定不会返回旧数据。



2. Availability(可用性): 任何操作都可以得到响应结果，并且不会出现超时或响应错误。

   可用性的实现 

   1. 写入主数据库后要将数据同步到从数据库。 

   2. 由于要保证从数据库的可用性，不可将从数据库中的资源进行锁定。 

   3. 即时数据还没有同步过来，从数据库也要返回要查询的数据，哪怕是旧数据，如果连旧数据也没有则可以按照约定返回一个默认信息，但不能返回错误或响应超时。 

   分布式系统可用性的特点： 

   1. 所有请求都有响应，且不会出现响应超时或响应错误。

3. Partition tolerance(分区容错性)：可能因为网络分区而因网络问题导致节点间的通信失败，但此时仍可以对外提供服务。<font color="red">分区容忍性是分布式系统具备的基本能力</font>

   分区容忍性的实现： 

   1. 尽量使用异步取代同步操作，例如使用异步方式将数据从主数据库同步到从数据，这样结点之间能有效的实现 松耦合。 

   2. 添加从数据库结点，其中一个从结点挂掉其它从结点提供服务。 

   分布式分区容忍性的特点： 

   1. 分区容忍性分是布式系统具备的基本能力。 

CAP 原则的精髓就是要么 AP，要么 CP，要么 AC，但是不存在 CAP。应用最多得是AP

### BASE理论

BASE 是 Basically Available(基本可用)、Soft state(软状态)和 Eventually consistent (最终一致性)三个短语的缩 

写。BASE理论是对CAP中AP的一个扩展，通过牺牲强一致性来获得可用性，允许数据在一段时间内是不一致的，但最终都达到一致性状态，满足BASE理论的事务称为“柔性事务”

- 基本可用:分布式系统在出现故障时，允许损失部分可用功能，保证核心功能可用。如，电商网站交易付款出 

  现问题了，商品依然可以正常浏览。 

- 软状态:由于不要求强一致性，所以BASE允许系统中存在中间状态（也叫**软状态**），这个状态不影响系统可用 

  性，如订单的"支付中"、“数据同步中”等状态，待数据最终一致后状态改为“成功”状态。 

- 最终一致:最终一致是指经过一段时间后，所有节点数据都将会达到一致。如订单的"支付中"状态，最终会变 

  为“支付成功”或者"支付失败"，使订单状态与实际交易结果达成一致，但需要一定时间的延迟、等待。 

本地事务：通过关系型数据库的事务特性来控制事务的方式称为本地事务

## 分布式事务的解决方案

1. 2PC(两阶段提交)

   解决方案：

   XA方案就是基于数据库的2PC协议的分布式事务























1. AT模式(自动模式的2PC)：拦截sql语句，

2. 两阶段提交协议 2PC(Two Phase Commitment Protocol)

   第一阶段：准备

   第二阶段：资源提交/回滚

2. TCC(Try-Confirm-Cancel)[服务化的两阶段提交协议]

   第一阶段：try(检测预留资源)

   第二阶段：confirm(真正的业务操作提交)/cancel(预留资源释放)

3. **Saga** 



TM: 事务管理器，开启，提交，回滚分布式事务

RM：资源管理器，注册，汇报，执行资源

TC：事务协调器：存储事务日志，补偿异常事务等



流程：

1. 事务开始时服务的TM向TC服务器请求开启事务，TC返回一个XID给TM
2. 事务开始执行服务的各个分支事务
3. 每个分支事务执行时RM将分支事务注册到TC上
4. 分支事务执行完成后，TC会逐个执行分支事务的Commit方法，commit每个事务的二阶段
5. 失败是TC调用每个RM注册的rollback方法









