# Distribution Transaction

- 数据的并发访问、修改
- 不同请求之间的数据隔离
- 一个业务请求修改多个数据，保证都完成或失败
- 发生异常时进行数据回滚

jta：xa规范在java的实现

分布式事务就是为了解决不同数据源间的事务特性

强一致性，弱一致性，最终一致性

强一致性：系统中的数据与操作顺序完全一致，任意时刻，所有节点中的数据都是一样的、

弱一致性：数据更新后，可以容忍后续的访问只能访问到部分或者全部访问不到

最终一致性：不保证任意时刻任意节点上的同一份数据都是相同的，但在一段数据后节点间的数据最终后达到一致的状态

CAP 原则又称 CAP 定理，指的是在一个分布式系统中， Consistency（一致性）、 Availability（可用性）、Partition tolerance（分区容错性），三者不可得兼。

Consistency(一致性)： 在分布式系统中，一个节点已提交的操作都可以立即被其他节点查询到

Availability(可用性): 集群中一部分节点故障后集群整体可以继续响应客户端的请求

Partition tolerance(分区容错性)：以实际效果而言，分区相当于对通信的时限要求。系统如果不能在时限内达成数据一致性，就意味着发生了分区的情况，必须就当前操作在 C 和 A 之间做出选择。

CAP 原则的精髓就是要么 AP，要么 CP，要么 AC，但是不存在 CAP。

## 分布式事务的解决方案

1. AT模式(自动模式)：拦截sql语句，

2. 两阶段提交协议 2PC(Two Phase Commitment Protocol)

   第一阶段：准备

   第二阶段：资源提交/回滚

2. TCC(Try-Confirm-Cancel)[服务化的两阶段提交协议]

   第一阶段：try(检测预留资源)

   第二阶段：confirm(真正的业务操作提交)/cancel(预留资源释放)

3. **Saga** 



TM: 事务管理器，开启，提交，回滚分布式事务

RM：资源管理器，注册，汇报，执行资源

TC：事务协调器：存储事务日志，补偿异常事务等



流程：

1. 事务开始时服务的TM向TC服务器请求开启事务，TC返回一个XID给TM
2. 事务开始执行服务的各个分支事务
3. 每个分支事务执行时RM将分支事务注册到TC上
4. 分支事务执行完成后，TC会逐个执行分支事务的Commit方法，commit每个事务的二阶段
5. 失败是TC调用每个RM注册的rollback方法

