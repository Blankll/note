

## TCP三次握手

第一次握手：客户端发送 syn 包 (syn=x) 到服务器，并进入 SYN_SEND 状态，等待服务器确认；

第二次握手：服务器收到 syn 包，必须确认客户的 SYN（ack=x+1），同时自己也发送一个 SYN 包（syn=y），即 SYN+ACK 包，此时服务器进入 SYN_RECV 状态；

第三次握手：客户端收到服务器的 SYN＋ACK 包，向服务器发送确认包 ACK(ack=y+1)，此包发送完毕，客户端和服务器进入 ESTABLISHED 状态，完成三次握手。

握手过程中传送的包里不包含数据，三次握手完毕后，客户端与服务器才正式开始传送数据。理想状态下，TCP 连接一旦建立，在通信双方中的任何一方主动关闭连接之前，TCP 连接都将被一直保持下去。



- TCP基于以字节为单位的滑动窗口来实现可靠传输
  - 发送方在未收到接收方的确认时,可将发送窗口内还未发送的数据全部发送出去;
  - 接收方只接收序号落入发送窗口内的数据
- 虽然发送方的发送窗口是根据接收方的接收窗口设置的,但在同一时刻,发送方的窗口并不总是和接收方的接收窗口一样大
  - 网络传送窗口值需要经历一定的时间滞后,并且这个时间是不确定的
  - 发送方还可能根据当前网络拥塞情况调整自己的发送窗口尺寸
- 对于不按序到达的数据应如何处理,TCP并无明确规定
  - 如果简单的将不按序到达的数据一并丢弃,那么接收窗口管理会比较简单,但这样做对网络资源的利用不利,因为发送方需要传送更多的数据
  - TCP通常将不按序到达的数据先临时存放到接收窗口中,等到字节流中所缺少的字节收到后,再按序交付给上层应用进程
- TCP要求接收方必须有累积确认和捎带确认机制,这样可以减少传输开销,接收方可以在合适的时候发送确认,也可以在自己有数据要发送时把确认信息顺便捎带上
  - 接收方不应过分推迟发送确认,否则会导致发送方不必要的超时重传,浪费网络资源
  - TCP标准规定,推迟确认的时间不应该超过0.5s,若收到一连串具有较大长度的报文段,则必须每隔一个报文段就发送一个确认报文[RFC1122]
  - 捎带确认实际上并不经常发生,因为大多数应用实际上很少同时在两个方向上发送数据
- TCP的通信是全双工通信,通信中的每一方都在发送和接收报文段,因此,每一方都有自己的发送窗口和接收窗口.因此要弄清楚是哪一方的窗口